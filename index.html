<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Öğrenci Bilgi Sistemi</title>

  <!-- Tailwind CSS (modern tasarım) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse (CSV parse) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    /* Küçük görsel dokunuşlar */
    .card { @apply bg-white shadow-lg rounded-xl p-6; }
    .btn  { @apply inline-flex items-center justify-center rounded-lg px-4 py-2 font-medium transition-colors; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-secondary { @apply bg-gray-100 text-gray-900 hover:bg-gray-200; }
    .input { @apply w-full rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500; }
    .badge  { @apply inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium; }
    .badge-green { @apply bg-emerald-100 text-emerald-700; }
    .badge-red   { @apply bg-rose-100 text-rose-700; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <header class="border-b bg-white">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl font-semibold">Öğrenci Bilgi Sistemi</h1>
      <div id="userBar" class="text-sm text-gray-600"></div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-8 space-y-8">
    <!-- Adım 1: Öğretmen seçimi -->
    <section id="stepSelectTeacher" class="card">
      <h2 class="text-lg font-semibold mb-4">Giriş — Öğretmen Seçimi</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium mb-1">Öğretmen</label>
          <select id="teacherSelect" class="input">
            <option value="">Seçiniz...</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button id="btnGoVerify" class="btn btn-primary">Devam</button>
          <button id="btnReloadTeachers" class="btn btn-secondary">Listeleri Yenile</button>
        </div>
      </div>
      <p id="teacherLoadStatus" class="mt-3 text-sm text-gray-600"></p>
    </section>

    <!-- Adım 2: Güvenlik doğrulaması -->
    <section id="stepVerify" class="card hidden">
      <h2 class="text-lg font-semibold mb-4">Güvenlik Doğrulaması</h2>
      <p class="text-sm text-gray-600 mb-4">Doğum tarihinin ilk 4 rakamı — format: GGAA (örn. 0205).</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium mb-1">Şifre (GGAA)</label>
          <input id="passwordInput" type="password" class="input" placeholder="GGAA" />
        </div>
        <div class="flex gap-2">
          <button id="btnVerify" class="btn btn-primary">Giriş Yap</button>
          <button id="btnBackSelect" class="btn btn-secondary">Geri</button>
        </div>
      </div>
      <p id="verifyStatus" class="mt-3 text-sm"></p>
    </section>

    <!-- Adım 3: Sınıf ve öğrenciler -->
    <section id="stepClass" class="card hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Sınıf — Öğrenci Listesi</h2>
        <div class="flex gap-2">
          <button id="btnRefreshClass" class="btn btn-secondary">Listeyi Yenile</button>
          <button id="btnLogout" class="btn btn-secondary">Çıkış</button>
        </div>
      </div>

      <div id="classMeta" class="text-sm text-gray-700 mb-4"></div>

      <div class="overflow-x-auto border rounded-xl">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">#</th>
              <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Adı</th>
              <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Soyadı</th>
              <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Numara</th>
              <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">Durum</th>
              <th class="px-4 py-2 text-left text-xs font-semibold text-gray-700">İşlem</th>
            </tr>
          </thead>
          <tbody id="studentsTable" class="divide-y divide-gray-200 bg-white"></tbody>
        </table>
      </div>
      <p id="classStatus" class="mt-3 text-sm text-gray-600"></p>
    </section>

    <!-- Modal: Öğrenci bilgi formu -->
    <section id="modalForm" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50">
      <div class="card max-w-2xl w-full">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-base font-semibold">Öğrenci Bilgi Formu</h3>
          <button id="btnCloseModal" class="btn btn-secondary">Kapat</button>
        </div>
        <form id="studentForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Adı</label>
              <input id="f_ad" class="input" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Soyadı</label>
              <input id="f_soyad" class="input" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Numara</label>
              <input id="f_numara" class="input" required />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Sınıf</label>
              <input id="f_sinif" class="input" required />
            </div>
          </div>

          <!-- Örnek ek alanlar: -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Veli Adı</label>
              <input id="f_veli_ad" class="input" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Veli Telefon</label>
              <input id="f_veli_tel" class="input" />
            </div>
          </div>

          <div class="flex items-center justify-between">
            <p id="formStatus" class="text-sm text-gray-600"></p>
            <button id="btnSubmitForm" class="btn btn-primary" type="submit">Kaydet</button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <footer class="mt-8 border-t bg-white">
    <div class="mx-auto max-w-6xl px-4 py-6 text-xs text-gray-500">
      GitHub Pages üzerinde yayınlanmıştır
    </div>
  </footer>

  <script>
    <script>
  const CONFIG = {
    // Öğretmen ve öğrenci listeleri aynı sheet'te ise buraya o ID'yi yaz
    SHEET_ID_LISTS: "1XX-VR8qAsi64CHPVWzkzKx82wBT5mbiPdtuectcdNEA",
    OGRETMENLER_GID: "71214639",
    OGRENCI_LISTESI_GID: "1771895607",

    // Öğrenci bilgi kayıtları ayrı sheet'te ise buraya o ID'yi yaz
    SHEET_ID_SUBMISSIONS: "1FzCECc-WntvPoGoTw-EKMIdc8VWrR0OQeeyFPXdxzhk",
    OGRENCI_BILGI_GID: "957162178",

    // Yazma için Google Apps Script Web App URL
    WRITE_SCRIPT_URL: "https://script.google.com/macros/s/AKfycbwh_yuAhibe6zshqlaBjjay4VBlyABvlE080qVN51SHmoggoCZL6dYGYXX0F_VxMKL08w/exec",
    USE_CORS_PROXY: false
  };

  function csvUrl(sheetId, gid){
    const base = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
    return CONFIG.USE_CORS_PROXY ? `https://corsproxy.io/?${base}` : base;
  }

  // Örnek kullanım:
  // fetch(csvUrl(CONFIG.SHEET_ID_LISTS, CONFIG.OGRETMENLER_GID))
  // fetch(csvUrl(CONFIG.SHEET_ID_SUBMISSIONS, CONFIG.OGRENCI_BILGI_GID))
</script>

    };

    // ========== YARDIMCI FONKSİYONLAR ==========
    const qs  = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));
    const show = el => el.classList.remove("hidden");
    const hide = el => el.classList.add("hidden");

    function csvUrl(gid){
      const base = `https://docs.google.com/spreadsheets/d/${CONFIG.SHEET_ID}/gviz/tq?tqx=out:csv&gid=${gid}`;
      return CONFIG.USE_CORS_PROXY ? `https://corsproxy.io/?${base}` : base;
    }

    function parseCsvToObjects(csv){
      const parsed = Papa.parse(csv, {
        header: true,
        transformHeader: h => h.trim().toLowerCase().replace(/\s+/g, "_")
      });
      return parsed.data.filter(row => Object.values(row).some(v => String(v||"").trim() !== ""));
    }

    function toastStatus(el, msg, type="info"){
      el.textContent = msg;
      el.className = "mt-3 text-sm " + (type==="error" ? "text-rose-600" : type==="success" ? "text-emerald-700" : "text-gray-600");
    }

    // Tarihten GGAA çıkar (ör: 02/05/1990 → 0205 veya 02.05.1990 → 0205)
    function first4FromDate(dobRaw){
      if(!dobRaw) return "";
      const s = String(dobRaw).replace(/[^\d]/g,""); // sadece rakamlar
      // Çoğu formatta ilk 4: GGAA
      return s.slice(0,4);
    }

    // ========== DURUM / BELLEK ==========
    const state = {
      teachers: [],
      studentsAll: [],
      submissions: [], // önceden girilmiş kayıtlar
      currentTeacher: null, // seçilen öğretmen objesi
      authed: false,        // doğrulama başarılı mı
      classStudents: []     // öğretmenin sınıfındaki öğrenciler
    };

    // ========== ÖĞRETMENLERİ YÜKLE ==========
    async function loadTeachers(){
      const statusEl = qs("#teacherLoadStatus");
      toastStatus(statusEl, "Öğretmen listesi yükleniyor...");
      try {
        const res = await fetch(csvUrl(CONFIG.OGRETMENLER_GID));
        const csv = await res.text();
        state.teachers = parseCsvToObjects(csv);
        const sel = qs("#teacherSelect");
        sel.innerHTML = `<option value="">Seçiniz...</option>`;
        state.teachers.forEach(t => {
          // beklenen başlık: ogretmen_adi, dogum_tarihi, sinif (veya sınıfı)
          const name = t.ogretmen_adi || t.ad || t.isim || t.adı || "";
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          sel.appendChild(opt);
        });
        toastStatus(statusEl, `Toplam ${state.teachers.length} öğretmen yüklendi.`, "success");
      } catch(err){
        console.error("Öğretmen listesi yüklenemedi:", err);
        toastStatus(statusEl, "Öğretmen listesi yüklenemedi!", "error");
      }
    }

    // ========== ÖĞRENCİLERİ YÜKLE ==========
    async function loadStudents(){
      const classStatus = qs("#classStatus");
      toastStatus(classStatus, "Öğrenciler yükleniyor...");
      try {
        const res = await fetch(csvUrl(CONFIG.OGRENCI_LISTESI_GID));
        const csv = await res.text();
        state.studentsAll = parseCsvToObjects(csv);
        toastStatus(classStatus, `Toplam ${state.studentsAll.length} öğrenci bulundu.`, "success");
      } catch(err){
        console.error("Öğrenci listesi yüklenemedi:", err);
        toastStatus(classStatus, "Öğrenci listesi yüklenemedi!", "error");
      }
    }

    // ========== ÖNCEKİ KAYITLARI YÜKLE ==========
    async function loadSubmissions(){
      try {
        const res = await fetch(csvUrl(CONFIG.OGRENCI_BILGI_GID));
        const csv = await res.text();
        state.submissions = parseCsvToObjects(csv);
      } catch(err){
        console.warn("Kayıt kontrol listesi yüklenemedi (devam ediliyor):", err);
        state.submissions = [];
      }
    }

    // ========== ÖĞRETMEN SEÇİMİ SONRASI ==========
    function goToVerify(){
      const selVal = qs("#teacherSelect").value;
      if(!selVal){
        toastStatus(qs("#teacherLoadStatus"), "Lütfen öğretmen seçiniz.", "error");
        return;
      }
      // öğretmen objesini bul
      const t = state.teachers.find(x => {
        const name = x.ogretmen_adi || x.ad || x.isim || x.adı || "";
        return name === selVal;
      });
      if(!t){
        toastStatus(qs("#teacherLoadStatus"), "Öğretmen bulunamadı.", "error");
        return;
      }
      state.currentTeacher = t;
      hide(qs("#stepSelectTeacher"));
      show(qs("#stepVerify"));

      qs("#verifyStatus").textContent = "";
      qs("#userBar").textContent = `Seçilen öğretmen: ${selVal}`;
    }

    // ========== DOĞRULAMA ==========
    function verifyPassword(){
      const pwd = qs("#passwordInput").value.trim();
      if(!state.currentTeacher){
        toastStatus(qs("#verifyStatus"), "Öğretmen seçimi bulunamadı.", "error");
        return;
      }
      const expected = first4FromDate(state.currentTeacher.dogum_tarihi || state.currentTeacher.doğum_tarihi);
      if(!expected){
        toastStatus(qs("#verifyStatus"), "Öğretmen doğum tarihi verisi eksik.", "error");
        return;
      }
      if(pwd === expected){
        state.authed = true;
        toastStatus(qs("#verifyStatus"), "Doğrulama başarılı.", "success");
        // sınıfa geç
        hide(qs("#stepVerify"));
        showClass();
      } else {
        toastStatus(qs("#verifyStatus"), "Hatalı şifre.", "error");
      }
    }

    // ========== SINIFI GÖSTER ==========
    async function showClass(){
      show(qs("#stepClass"));
      // öğretmenin sınıf bilgisi
      const sinif = state.currentTeacher.sinif || state.currentTeacher.sınıf || state.currentTeacher.sınıfı || "";
      qs("#classMeta").textContent = `Öğretmen: ${(state.currentTeacher.ogretmen_adi || state.currentTeacher.adı || "")} — Sınıf: ${sinif || "Belirtilmemiş"}`;

      // öğrenciler yüklü değilse yükle
      if(state.studentsAll.length === 0){
        await loadStudents();
      }
      // daha önceki kayıtlar
      if(state.submissions.length === 0){
        await loadSubmissions();
      }

      // sınıfın öğrencileri
      state.classStudents = state.studentsAll.filter(s => {
        const sSinif = s.sınıf || s.sınıfı || s.sinif || "";
        return String(sSinif).trim() === String(sinif).trim();
      });

      // tabloyu doldur
      const tbody = qs("#studentsTable");
      tbody.innerHTML = "";
      state.classStudents.forEach((s, idx) => {
        const ad    = s.adı || s.ad || s.isim || "";
        const soyad = s.soyadı || s.soyad || "";
        const num   = s.numara || s.no || s.öğrenci_no || "";

        // daha önce dolduruldu mu? submissions içinde eşleşme kontrolü
        const hasSubmission = state.submissions.some(sub => {
          const sad    = sub.adı || sub.ad || sub.isim || "";
          const ssoyad = sub.soyadı || sub.soyad || "";
          const snum   = sub.numara || sub.no || sub.öğrenci_no || "";
          return String(sad).trim() === String(ad).trim()
              && String(ssoyad).trim() === String(soyad).trim()
              && String(snum).trim() === String(num).trim();
        });

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-4 py-2 text-sm text-gray-700">${idx+1}</td>
          <td class="px-4 py-2 text-sm">${ad}</td>
          <td class="px-4 py-2 text-sm">${soyad}</td>
          <td class="px-4 py-2 text-sm">${num}</td>
          <td class="px-4 py-2">
            ${hasSubmission
              ? `<span class="badge badge-green">Daha önce dolduruldu</span>`
              : `<span class="badge badge-red">Eksik</span>`}
          </td>
          <td class="px-4 py-2">
            <button class="btn btn-primary text-xs" data-action="fill" data-index="${idx}" ${hasSubmission ? "disabled" : ""}>
              Bilgi Gir
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      toastStatus(qs("#classStatus"), `Sınıfta ${state.classStudents.length} öğrenci listelendi.`, "success");
    }

    // ========== FORM MODALI ==========
    function openFormModal(idx){
      const s = state.classStudents[idx];
      if(!s) return;
      show(qs("#modalForm"));
      // Form alanlarını doldur
      const ad    = s.adı || s.ad || s.isim || "";
      const soyad = s.soyadı || s.soyad || "";
      const num   = s.numara || s.no || s.öğrenci_no || "";
      const sinif = s.sınıf || s.sınıfı || s.sinif || "";

      qs("#f_ad").value     = ad;
      qs("#f_soyad").value  = soyad;
      qs("#f_numara").value = num;
      qs("#f_sinif").value  = sinif;

      qs("#formStatus").textContent = "";
      qs("#btnSubmitForm").disabled = false;
      qs("#btnSubmitForm").dataset.idx = idx;
    }

    function closeFormModal(){
      hide(qs("#modalForm"));
    }

    // ========== KAYDET (Apps Script'e POST) ==========
    async function submitForm(e){
      e.preventDefault();
      const idx = qs("#btnSubmitForm").dataset.idx;
      const s   = state.classStudents[idx];
      if(!s){ return; }

      const payload = {
        // Öğrenci temel alanları
        ad: qs("#f_ad").value.trim(),
        soyad: qs("#f_soyad").value.trim(),
        numara: qs("#f_numara").value.trim(),
        sinif: qs("#f_sinif").value.trim(),
        // Ek alanlar
        veli_ad: qs("#f_veli_ad").value.trim(),
        veli_tel: qs("#f_veli_tel").value.trim(),
        // Öğretmen ve zaman damgası
        ogretmen: (state.currentTeacher.ogretmen_adi || state.currentTeacher.adı || ""),
        ts: new Date().toISOString()
      };

      qs("#btnSubmitForm").disabled = true;
      toastStatus(qs("#formStatus"), "Kaydediliyor...");

      try {
        const res = await fetch(CONFIG.WRITE_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          throw new Error(`HTTP ${res.status}`);
        }
        const data = await res.json().catch(()=>({ok:true}));
        toastStatus(qs("#formStatus"), "Kayıt başarıyla eklendi.", "success");

        // submissions'a ekle ve sınıf listesini güncelle
        state.submissions.push({
          adı: payload.ad, soyadı: payload.soyad, numara: payload.numara
        });
        closeFormModal();
        showClass();
      } catch(err){
        console.error("Kaydet hatası:", err);
        toastStatus(qs("#formStatus"), "Kaydetme sırasında hata oluştu.", "error");
        qs("#btnSubmitForm").disabled = false;
      }
    }

    // ========== OLAYLAR ==========
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if(!btn) return;

      // Öğretmen adımdan doğrulamaya
      if(btn.id === "btnGoVerify"){ goToVerify(); }
      if(btn.id === "btnReloadTeachers"){ loadTeachers(); }

      // Doğrulama
      if(btn.id === "btnVerify"){ verifyPassword(); }
      if(btn.id === "btnBackSelect"){
        hide(qs("#stepVerify"));
        show(qs("#stepSelectTeacher"));
      }

      // Sınıf ekranı
      if(btn.id === "btnRefreshClass"){ showClass(); }
      if(btn.id === "btnLogout"){
        state.currentTeacher = null;
        state.authed = false;
        hide(qs("#stepClass"));
        hide(qs("#stepVerify"));
        show(qs("#stepSelectTeacher"));
        qs("#userBar").textContent = "";
      }

      // Tablo: Bilgi Gir
      if(btn.dataset.action === "fill"){
        const idx = Number(btn.dataset.index || -1);
        openFormModal(idx);
      }

      // Modal
      if(btn.id === "btnCloseModal"){ closeFormModal(); }
    });

    qs("#studentForm").addEventListener("submit", submitForm);

    // ========== BAŞLAT ==========
    (async function init(){
      await loadTeachers();
    })();
  </script>
</body>
</html>
